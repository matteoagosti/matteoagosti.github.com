
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>How to properly deal with Javascript asynchronous code - Matteo Agosti</title>
  <meta name="author" content="Matteo Agosti">

  
  <meta name="description" content="How to Properly Deal With Javascript Asynchronous Code Sep 3rd, 2012 If you are a Javascript developer, you have to deal with asynchronous code. If &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.matteoagosti.com/blog/2012/09/03/how-to-properly-deal-with-javascript-asynchronous-code/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Matteo Agosti" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-2101303-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Matteo Agosti</a></h1>
  
    <h2>Software engineer</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.matteoagosti.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">How to Properly Deal With Javascript Asynchronous Code</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-03T12:15:00+02:00" pubdate data-updated="true">Sep 3<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>If you are a Javascript developer, you have to deal with asynchronous code. If you are a Javascript developer working with Node.js, asynchronous code is your all in a day&#8217;s work. Let&#8217;s see how to properly deal with asynchronous code, avoiding one of the most common mistake.</p>

<!-- more-->


<p>The instrinsic nature of asynchronous code is that its execution block can occur indipendently of the main program flow, thus providing a non blocking mechanism of executing actions. This means that, potentially, when the asynchronous code runs the status of any shared variables could be different than the one where the code was defined.</p>

<p>Consider the following example:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">rankings</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="s1">&#39;eve&#39;</span><span class="p">];</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">rankings</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">rankings</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
</span><span class='line'>  <span class="p">},</span> <span class="nx">i</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The idea is to print every name from the <code>rankings</code> array together with its index. To make the code asynchronous every print is delayed by one second from its predecessor. The output we get is, however, different than what we expected it to be:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="mi">3</span> <span class="kc">undefined</span>
</span><span class='line'><span class="mi">3</span> <span class="kc">undefined</span>
</span><span class='line'><span class="mi">3</span> <span class="kc">undefined</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, by the time the asynchronous block is executed, the loop is already ended, so the value of variable <code>i</code> is the one that stops the loop (<code>3</code>). How to prevent this behavior? The answer are <strong>closures</strong>, one of the most powerful features of Javascript; a closure can be seen as a retained scope for Javascript, a function that can have its own variables together with an environment where those variables are binded.</p>

<p>Let&#8217;s fix the previous example using closures:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">rankings</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="s1">&#39;eve&#39;</span><span class="p">];</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">rankings</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">rankings</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">},</span> <span class="nx">i</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
</span><span class='line'>  <span class="p">})(</span><span class="nx">i</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see the <code>setTimeout</code> function is wrapped within a closure that has an <code>i</code> argument, whose value is passed at the end of closure definition and corresponds to the loop varialbe <code>i</code>. The output we get is the correct one:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="mi">0</span> <span class="s1">&#39;alice&#39;</span>
</span><span class='line'><span class="mi">1</span> <span class="s1">&#39;bob&#39;</span>
</span><span class='line'><span class="mi">2</span> <span class="s1">&#39;eve&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is a really simple example and in this case detecting the error is fairly easy, however when you have to deal with nested async calls the execution flow gets more complex and it may become extremely painful to detect where the error is. Hopefully this helps, as it helped me in writing better code :)</p>
</div>



  <p>If you want to discuss about this article, I'm <a href="https://twitter.com/matteoagosti" title="Contact me on Twitter" rel="nofollow">@matteoagosti on Twitter</a>.
    
  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Matteo Agosti</span></span>

      








  


<time datetime="2012-09-03T12:15:00+02:00" pubdate data-updated="true">Sep 3<span>rd</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/development/'>Development</a>, <a class='category' href='/blog/categories/javascript/'>JavaScript</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.matteoagosti.com/blog/2012/09/03/how-to-properly-deal-with-javascript-asynchronous-code/" data-via="matteoagosti" data-counturl="http://www.matteoagosti.com/blog/2012/09/03/how-to-properly-deal-with-javascript-asynchronous-code/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/07/03/10-reasons-why-blog-platforms-won-t-foster-your-writing/" title="Previous Post: 10 reasons why blog platforms won't foster your writing">&laquo; 10 reasons why blog platforms won't foster your writing</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/10/28/automatic-screen-shot-sharing-with-dropbox-and-automator/" title="Next Post: Automatic screen shot sharing with Dropbox and Automator">Automatic screen shot sharing with Dropbox and Automator &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/02/24/writing-javascript-modules-for-both-browser-and-node/">Writing JavaScript modules for both Browser and Node.js</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/22/rate-limiting-function-calls-in-javascript/">Rate limiting function calls in JavaScript</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/17/drupal-website-development-using-a-git-workflow/">Drupal website development using a GIT workflow</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/16/the-rationale-behind-andthewinner-is-a-platform-for-viral-contests-on-twitter/">The rationale behind andthewinner.is, a platform for viral contests on Twitter</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/28/automatic-screen-shot-sharing-with-dropbox-and-automator/">Automatic screen shot sharing with Dropbox and Automator</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("matteoagosti", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/matteoagosti" class="twitter-follow-button" data-show-count="false">Follow @matteoagosti</a>
  
</section>



<section class="googleplus googleplus-hidden">
  <h1>
    <a href="https://plus.google.com/100338091555197609658?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Matteo Agosti -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
